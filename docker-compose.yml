version: "3.8"

services:
  # --- Backend ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: maintenance-backend # هذا الاسم سنستخدمه في التوجيه
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      API_PREFIX: api/v1
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-8h}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      CORS_ORIGIN: ${CORS_ORIGIN:-https://maintenance.smartagency-ye.com}
      CACHE_TTL: ${CACHE_TTL:-300}
      CACHE_MAX: ${CACHE_MAX:-100}
      THROTTLE_TTL: ${THROTTLE_TTL:-60}
      THROTTLE_LIMIT: ${THROTTLE_LIMIT:-100}
    networks:
      - web-network # الربط بالشبكة المشتركة

  # --- Frontend ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # انتبه: الرابط هنا يجب أن يكون الدومين الخارجي لأن هذا يعمل بمتصفح العميل
        VITE_API_URL: https://api-maintenance.smartagency-ye.com/api/v1
    container_name: maintenance-frontend
    restart: unless-stopped
    networks:
      - web-network

# تعريف الشبكة الخارجية
networks:
  web-network:
    external: true
